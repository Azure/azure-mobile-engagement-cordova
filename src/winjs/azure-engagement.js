/*
 Copyright (c) Microsoft Corporation. All rights reserved.
*/
/*
 (c) 2009-2013 by Jeff Mott. All rights reserved.
*/
(function(h,t){if(!window.azureEngagement)window.azureEngagement={};var i=azureEngagement.Crypto={},b=i.lib={},g=b.Base=function(){function e(){}return{extend:function(n){e.prototype=this;var q=new e;n&&q.mixIn(n);if(!q.hasOwnProperty("init"))q.init=function(){q.$super.init.apply(this,arguments)};q.init.prototype=q;q.$super=this;return q},create:function(){var n=this.extend();n.init.apply(n,arguments);return n},init:function(){},mixIn:function(n){for(var q in n)if(n.hasOwnProperty(q))this[q]=n[q];
if(n.hasOwnProperty("toString"))this.toString=n.toString},clone:function(){return this.init.prototype.extend(this)}}}(),c=b.WordArray=g.extend({init:function(e,n){e=this.words=e||[];this.sigBytes=n!=t?n:e.length*4},toString:function(e){return(e||l).stringify(this)},concat:function(e){var n=this.words,q=e.words,r=this.sigBytes;e=e.sigBytes;this.clamp();if(r%4)for(var s=0;s<e;s++)n[r+s>>>2]|=(q[s>>>2]>>>24-s%4*8&255)<<24-(r+s)%4*8;else if(q.length>65535)for(s=0;s<e;s+=4)n[r+s>>>2]=q[s>>>2];else n.push.apply(n,
q);this.sigBytes+=e;return this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-n%4*8;e.length=h.ceil(n/4)},clone:function(){var e=g.clone.call(this);e.words=this.words.slice(0);return e},random:function(e){for(var n=[],q=0;q<e;q+=4)n.push(h.random()*4294967296|0);return new c.init(n,e)}}),m=i.enc={},l=m.Hex={stringify:function(e){var n=e.words;e=e.sigBytes;for(var q=[],r=0;r<e;r++){var s=n[r>>>2]>>>24-r%4*8&255;q.push((s>>>4).toString(16));q.push((s&15).toString(16))}return q.join("")},
parse:function(e){for(var n=e.length,q=[],r=0;r<n;r+=2)q[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new c.init(q,n/2)}},d=m.Latin1={stringify:function(e){var n=e.words;e=e.sigBytes;for(var q=[],r=0;r<e;r++)q.push(String.fromCharCode(n[r>>>2]>>>24-r%4*8&255));return q.join("")},parse:function(e){for(var n=e.length,q=[],r=0;r<n;r++)q[r>>>2]|=(e.charCodeAt(r)&255)<<24-r%4*8;return new c.init(q,n)}},o=m.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(n){throw Error("Malformed UTF-8 data");
}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},k=b.BufferedBlockAlgorithm=g.extend({reset:function(){this._data=new c.init;this._nDataBytes=0},_append:function(e){if(typeof e=="string")e=o.parse(e);this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(e){var n=this._data,q=n.words,r=n.sigBytes,s=this.blockSize,A=r/(s*4);A=e?h.ceil(A):h.max((A|0)-this._minBufferSize,0);e=A*s;r=h.min(e*4,r);if(e){for(var x=0;x<e;x+=s)this._doProcessBlock(q,x);x=q.splice(0,e);n.sigBytes-=
r}return new c.init(x,r)},clone:function(){var e=g.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});b.Hasher=k.extend({cfg:g.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){k.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(n,q){return(new e.init(q)).finalize(n)}},_createHmacHelper:function(e){return function(n,
q){return(new j.HMAC.init(e,q)).finalize(n)}}});var j=i.algo={};return i})(Math);(function(){var h=azureEngagement.Crypto,t=h.lib.WordArray;h.enc.Base64={stringify:function(i){var b=i.words,g=i.sigBytes,c=this._map;i.clamp();i=[];for(var m=0;m<g;m+=3)for(var l=(b[m>>>2]>>>24-m%4*8&255)<<16|(b[m+1>>>2]>>>24-(m+1)%4*8&255)<<8|b[m+2>>>2]>>>24-(m+2)%4*8&255,d=0;d<4&&m+d*0.75<g;d++)i.push(c.charAt(l>>>6*(3-d)&63));if(b=c.charAt(64))for(;i.length%4;)i.push(b);return i.join("")},parse:function(i){var b=i.length,g=this._map,c=g.charAt(64);if(c){c=i.indexOf(c);if(c!=-1)b=c}c=[];for(var m=
0,l=0;l<b;l++)if(l%4){var d=g.indexOf(i.charAt(l-1))<<l%4*2,o=g.indexOf(i.charAt(l))>>>6-l%4*2;c[m>>>2]|=(d|o)<<24-m%4*8;m++}return t.create(c,m)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(h){var t=azureEngagement.Crypto,i=t.lib,b=i.WordArray,g=i.Hasher;i=t.algo;var c=[],m=[];(function(){function d(e){for(var n=h.sqrt(e),q=2;q<=n;q++)if(!(e%q))return false;return true}function o(e){return(e-(e|0))*4294967296|0}for(var k=2,j=0;j<64;){if(d(k)){if(j<8)c[j]=o(h.pow(k,0.5));m[j]=o(h.pow(k,1/3));j++}k++}})();var l=[];i=i.SHA256=g.extend({_doReset:function(){this._hash=new b.init(c.slice(0))},_doProcessBlock:function(d,o){for(var k=this._hash.words,j=k[0],e=k[1],n=k[2],q=k[3],r=
k[4],s=k[5],A=k[6],x=k[7],w=0;w<64;w++){if(w<16)l[w]=d[o+w]|0;else{var C=l[w-15],B=l[w-2];l[w]=((C<<25|C>>>7)^(C<<14|C>>>18)^C>>>3)+l[w-7]+((B<<15|B>>>17)^(B<<13|B>>>19)^B>>>10)+l[w-16]}C=x+((r<<26|r>>>6)^(r<<21|r>>>11)^(r<<7|r>>>25))+(r&s^~r&A)+m[w]+l[w];B=((j<<30|j>>>2)^(j<<19|j>>>13)^(j<<10|j>>>22))+(j&e^j&n^e&n);x=A;A=s;s=r;r=q+C|0;q=n;n=e;e=j;j=C+B|0}k[0]=k[0]+j|0;k[1]=k[1]+e|0;k[2]=k[2]+n|0;k[3]=k[3]+q|0;k[4]=k[4]+r|0;k[5]=k[5]+s|0;k[6]=k[6]+A|0;k[7]=k[7]+x|0},_doFinalize:function(){var d=this._data,
o=d.words,k=this._nDataBytes*8,j=d.sigBytes*8;o[j>>>5]|=128<<24-j%32;o[(j+64>>>9<<4)+14]=h.floor(k/4294967296);o[(j+64>>>9<<4)+15]=k;d.sigBytes=o.length*4;this._process();return this._hash},clone:function(){var d=g.clone.call(this);d._hash=this._hash.clone();return d}});t.SHA256=g._createHelper(i);t.HmacSHA256=g._createHmacHelper(i)})(Math);/*
 Copyright 2006-2008, OGG, LLC
*/
(function(h){function t(b,g){return new i.Builder(b,g)}var i;i={VERSION:"@VERSION@",addNamespace:function(b,g){i.NS[b]=g},ElementType:{NORMAL:1,TEXT:3,CDATA:4},forEachChild:function(b,g,c){var m,l;for(m=0;m<b.childNodes.length;m++){l=b.childNodes[m];if(l.nodeType==i.ElementType.NORMAL&&(!g||this.isTagEqual(l,g)))c(l)}},isTagEqual:function(b,g){return b.tagName.toLowerCase()==g.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var b;if(document.implementation.createDocument)b=document.implementation.createDocument("jabber:client",
"strophe",null);else if(window.ActiveXObject){b=this._getIEXmlDom();b.appendChild(b.createElement("strophe"))}return b},xmlGenerator:function(){if(!i._xmlGenerator)i._xmlGenerator=i._makeGenerator();return i._xmlGenerator},_getIEXmlDom:function(){for(var b=null,g=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],c=0;c<g.length;c++)if(b===null)try{b=new ActiveXObject(g[c])}catch(m){b=null}else break;
return b},xmlElement:function(b){if(!b)return null;var g=i.xmlGenerator().createElement(b),c,m,l;for(c=1;c<arguments.length;c++)if(arguments[c])if(typeof arguments[c]=="string"||typeof arguments[c]=="number")g.appendChild(i.xmlTextNode(arguments[c]));else if(typeof arguments[c]=="object"&&typeof arguments[c].sort=="function")for(m=0;m<arguments[c].length;m++)typeof arguments[c][m]=="object"&&typeof arguments[c][m].sort=="function"&&g.setAttribute(arguments[c][m][0],arguments[c][m][1]);else if(typeof arguments[c]==
"object")for(l in arguments[c])arguments[c].hasOwnProperty(l)&&g.setAttribute(l,arguments[c][l]);return g},xmlescape:function(b){b=b.replace(/\&/g,"&amp;");b=b.replace(/</g,"&lt;");return b=b.replace(/>/g,"&gt;")},xmlTextNode:function(b){b=i.xmlescape(b);return i.xmlGenerator().createTextNode(b)},getText:function(b){if(!b)return null;var g="";if(b.childNodes.length===0&&(b.nodeType==i.ElementType.TEXT||b.nodeType==i.ElementType.CDATA))g+=b.nodeValue;for(var c=0;c<b.childNodes.length;c++){var m=b.childNodes[c];
if(m.nodeType==i.ElementType.TEXT||m.nodeType==i.ElementType.CDATA)g+=b.childNodes[c].nodeValue}return g},copyElement:function(b){var g,c;if(b.nodeType==i.ElementType.NORMAL){c=i.xmlElement(b.tagName);for(g=0;g<b.attributes.length;g++)c.setAttribute(b.attributes[g].nodeName.toLowerCase(),b.attributes[g].value);for(g=0;g<b.childNodes.length;g++)c.appendChild(i.copyElement(b.childNodes[g]))}else if(b.nodeType==i.ElementType.TEXT||b.nodeType==i.ElementType.CDATA)c=i.xmlTextNode(b.nodeValue);return c},
serialize:function(b){var g;if(!b)return null;if(typeof b.tree==="function")b=b.tree();var c=b.nodeName,m,l;if(b.getAttribute("_realname"))c=b.getAttribute("_realname");g="<"+c;for(m=0;m<b.attributes.length;m++)if(b.attributes[m].nodeName!="_realname")g+=" "+b.attributes[m].nodeName+"='"+b.attributes[m].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'";if(b.childNodes.length>0){g+=">";for(m=0;m<b.childNodes.length;m++){l=b.childNodes[m];if(l.nodeType==i.ElementType.NORMAL)g+=
i.serialize(l);else if(l.nodeType==i.ElementType.TEXT)g+=l.nodeValue;else if(l.nodeType==i.ElementType.CDATA)g+="<![CDATA["+l.nodeValue+"]]\>"}g+="</"+c+">"}else g+="/>";return g}};i.Builder=function(b,g){this.node=this.nodeTree=i.xmlElement(b,g)};i.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return i.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(b){for(var g in b)b.hasOwnProperty(g)&&this.node.setAttribute(g,b[g]);
return this},c:function(b,g){var c=i.xmlElement(b,g);this.node.appendChild(c);this.node=c;return this},cnode:function(b){var g=i.xmlGenerator(),c;try{c=g.importNode(b,true)}catch(m){c=i.copyElement(b)}this.node.appendChild(c);this.node=c;return this},t:function(b){this.node.appendChild(i.xmlTextNode(b));return this}};h&&h(i,t)})(function(h,t){azureEngagement.Strophe=h;azureEngagement.$build=t});/*
 Copyright (c) Microsoft Corporation. All rights reserved.
*/
(function(){var h=azureEngagement;if(!h.connectionString)throw Error("azureEngagement.connectionString must be set");h.alias=h.alias||"engagement";window[h.alias]=h;if(typeof h.sessionTimeout!="number")h.sessionTimeout=1E4;h.serviceVersion="2.0.0";h.tag=h.tag||"ENGAGEMENT";h.urls=h.urls||{};h.urls.scheme=h.urls.scheme||"https://";h.urls.getIpToCountryUrl=h.urls.getIpToCountryUrl||function(){return h.endPoint+"/ip-to-country"};h.urls.getLoggerUrl=h.urls.getLoggerUrl||function(){return h.endPoint+"/log"};
h.utils=function(){var t=h.Crypto,i=t.enc,b="0123456789abcdef".split(""),g=function(d){return d<10?"0"+d:d},c=function(){return window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)?function(d,o,k){var j=new XDomainRequest;j.onload=function(){l.logAjaxResult(d,j);o(j);l.destroyAjax(j)};j.onerror=function(){k(j);l.destroyAjax(j)};return j}:window.XMLHttpRequest?function(d,o,k){var j=new XMLHttpRequest;j.onreadystatechange=function(){if(j.readyState==4){l.logAjaxResult(d,j);j.status==200?
o(j):k(j);l.destroyAjax(j)}};return j}:function(){}}(),m=function(d,o,k,j,e,n,q){if(e=c(o,e,n)){h.debug&&h.console.log("SEND: "+d,o);e.open(d,o,true);k&&e.setRequestHeader("Authorization",k);e.withCredentials=false;try{e.send(j)}catch(r){q(r)}}},l={printCurrentTime:function(){var d=new Date;return g(d.getHours())+":"+g(d.getMinutes())+":"+g(d.getSeconds())},hasClass:function(d,o){return(" "+l.trim(d.className)+" ").indexOf(" "+o+" ")>-1},addClass:function(d,o){if(l.hasClass(d,o)===false)d.className=
l.trim(d.className+" "+o)},removeClass:function(d,o){d.className=d.className.replace(RegExp("(^|\\s)"+o+"(?:\\s|$)"),"")},trim:String.trim||function(d){return d.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},uuid:function(){var d=[],o,k;d[12]="4";for(k=0;k<32;k++)if(!d[k]){o=0|Math.random()*16;d[k]=b[k==16?o&3|8:o]}return d.join("")},getTag:function(d,o){var k=d.getElementsByTagName(o);if(k.length)return k[0]},getText:function(d){if(d=h.Strophe.getText(d))return l.trim(d)},getTagText:function(d,o){return l.getText(l.getTag(d,
o))},getDateFromHours:function(d){var o=new Date;o.setTime(o.getTime()+d*36E5);return o},getCookie:function(d){d+="=";var o=document.cookie.split(";"),k;for(k=0;k<o.length;k++){for(var j=o[k];j.charAt(0)==" ";)j=j.substring(1,j.length);if(j.indexOf(d)===0)return j.substring(d.length,j.length)}return null},setCookie:function(d,o,k){k=k?"; expires="+l.getDateFromHours(k).toGMTString():"";document.cookie=d+"="+o+k+"; path=/"},deleteCookie:function(d){l.setCookie(d,"",-1)},addScheme:function(d){/^((https?:)?\/\/|\/)/.test(d)||
(d=h.urls.scheme+d);return d},Base64:{encode:function(d){return i.Base64.stringify(i.Utf8.parse(d))},decode:function(d){return i.Base64.parse(d).toString(i.Utf8)}},SHA256:{hash128:function(d){d=t.SHA256(d).toString(i.Hex);return d.substring(0,d.length/2)}},Ajax:{post:function(d,o,k,j,e,n){m("POST",d,o,k,j,e,n)},get:function(d,o,k,j,e){m("GET",d,o,null,k,j,e)}},destroyAjax:function(d){try{d.destroy()}catch(o){}},logAjaxResult:function(d,o){h.debug&&h.console.log("RECV:",d,o.responseText)},getQueryParameter:function(d){var o=
window.location.search.substring(1).split("&"),k;for(k=0;k<o.length;k++){var j=o[k].split("=");if(j[0]==d)return j[1]}},addListener:function(d,o,k){if(d)if(d.addEventListener)d.addEventListener(o,k);else d.attachEvent&&d.attachEvent(o,k)},removeListener:function(d,o,k){if(d)if(d.removeEventListener)d.removeEventListener(o,k);else d.detachEvent&&d.detachEvent(o,k)},retryer:function(d,o,k){var j=0;return{reset:function(){j=0},retry:function(e){var n=true;if(j==0)j=o;else if(j!=d)j=Math.min(j*k,d);else n=
false;if(n){n=j/2;j=n+parseInt(Math.random()*n)}console.log("Waiting "+j+"ms before retrying...");this.retryTimeout=setTimeout(function(){e()},j)}}}};return l}();h.storage=h.storage||function(){var t=h.utils,i;return i=window.localStorage?{set:function(b,g,c){if(c=="session"){sessionStorage[b]=JSON.stringify(g);localStorage.removeItem(b)}else{localStorage[b]=JSON.stringify({ttl:c?t.getDateFromHours(c).getTime():undefined,val:g});sessionStorage.removeItem(b)}},get:function(b){try{var g=sessionStorage[b];
if(g)return JSON.parse(g);else{g=localStorage[b];g=JSON.parse(g);if((new Date).getTime()>g.ttl){i.del(b);return null}else return g.val}}catch(c){return null}},del:function(b){sessionStorage.removeItem(b);localStorage.removeItem(b)}}:{get:t.getCookie,set:function(b,g,c){if(c){if(c=="session")c=null}else c=876E4;t.setCookie(b,g,c)},del:t.deleteCookie}}();h.console=h.console||function(){if(window.console){var t=navigator.userAgent.search("Android")>-1,i=t||navigator.userAgent.search("iPhone")>-1,b=Array.prototype.slice,
g=function(c,m){m=["["+h.tag+"]"].concat(m);t||(m=[h.utils.printCurrentTime()].concat(m));if(!c.apply||i){var l=m.join(" ");c.call?c.call(console,l):c(l)}else c.apply(console,m)};return{log:function(){h.debug&&g(console.log,b.apply(arguments))},error:function(){h.debug&&g(console.error,b.apply(arguments))},warn:function(){h.debug&&g(console.warn,b.apply(arguments))},info:function(){h.debug&&g(console.info,b.apply(arguments))}}}else return{log:function(){},error:function(){},warn:function(){},info:function(){}}}();
h.userAgent=function(){var t=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"iPad",identity:"iPad"},{string:navigator.platform,subString:"iPod",identity:"iPod"},{string:navigator.platform,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"hpwOS",
identity:"webOS"},{string:navigator.platform,subString:"SHADOW",identity:"Samsung TV"},{string:navigator.platform,subString:"Linux",identity:"Linux"}],i,b=function(c){var m;for(m=0;m<c.length;m++){var l=c[m].string,d=c[m].prop;i=c[m].versionSearch||c[m].identity;if(l){if(l.indexOf(c[m].subString)!=-1)return c[m].identity}else if(d)return c[m].identity}},g=function(c){var m=c.indexOf(i);if(m!=-1)return parseFloat(c.substring(m+i.length+1))};return{browser:b([{string:navigator.userAgent,subString:"Edge",
identity:"Edge"},{string:navigator.userAgent,subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"hpwOS",identity:"webOS",versionSearch:"hpwOS"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},
{string:navigator.vendor,subString:"KDE",identity:"Konqueror"},{string:navigator.appName,subString:"Maple",identity:"Maple"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Internet Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Android",identity:"WebKit",versionSearch:"Version"},
{string:navigator.userAgent,subString:"Trident",identity:"Internet Explorer",versionSearch:"rv"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}]),version:g(navigator.userAgent)||g(navigator.appVersion),platform:b(t)}}();h.agent=function(){var t=h.console,i=h.utils,b=h.storage,g=i.trim,c=i.uuid,m=h.Strophe,l=h.$build,d=/^[a-zA-Z][a-zA-Z_0-9]*$/,o={NONE:0,SOFT:1,HARD:2},
k=o.NONE,j=true,e=[],n=0,q,r,s,A,x,w,C=null,B={},K,M=i.SHA256.hash128,H={enabled:false,init:function(a,f){this.authHeader="Basic "+i.Base64.encode(h.deviceId+"."+h.appId+":"+h.sdkKey);this.retryer=i.retryer(36E5,6E4,2);var p=this;this.onEnabled=function(){t.info("Connection enabled");p.enabled=true;a()};this.onDisabled=function(){t.warn("Connection disabled");p.enabled=false;f();p.retryer.reset();n=0};this.enable()},enable:function(){if(!window.navigator||typeof window.navigator.onLine==="undefined"){t.warn("Can't monitor connection status, state forced to enabled.");
this.onEnabled()}else{if(window.navigator.onLine)this.onEnabled();else this.onDisabled();i.addListener(window,"online",this.onEnabled);i.addListener(window,"offline",this.onDisabled)}},disable:function(){i.removeListener(window,"online",this.onEnabled);i.removeListener(window,"offline",this.onDisabled);this.onDisabled()},sendLog:function(a){var f=this.retryer,p=i.addScheme(h.urls.getLoggerUrl());i.Ajax.post(p,this.authHeader,a.toString(),function(){f.reset();e=e.slice(n);n=0;N()},function(u){t.error("Error sending logs");
u=u.status;if(u==410)P(o.HARD);else if(u>=300&&u<500&&u!=408){P(o.SOFT);n=0}else f.retry(function(){n=0;N()})})}},y=function(a){this.message=a;this.name="["+h.tag+"] Error"};y.prototype=Error();var L=function(){var a=null,f=null,p={},u=null;return{start:function(){this.stop();u=setInterval(function(){if(a){var v;v=b.get(w);if(!v||v===f){b.set(w,f,0.025);v=true}else v=false;v?e.push(a):b.set(r,s,0.05)}for(var D in p)p.hasOwnProperty(D)&&e.push(p[D]);N()},6E4)},setCurrentActivityLog:function(v){if(v.log&&
v.timestamp){a={log:this.cloneWithRepost(v.log),timestamp:v.timestamp};f=v.log.tree().getAttribute("id");b.set(w,f,0.025)}},removeCurrentActivityLog:function(){b.get(w)===f&&b.del(w);f=a=null},addJobLog:function(v,D){if(v&&D.log&&D.timestamp)p[v]={log:this.cloneWithRepost(D.log),timestamp:D.timestamp}},removeJobLog:function(v){delete p[v]},cloneWithRepost:function(v){var D=h.$build(v.nodeTree.nodeName),O=v.nodeTree.attributes;v=v.nodeTree.childNodes;var F,Q={repost:"true"};for(F=0;F<O.length;F++)Q[O[F].name]=
O[F].value;D.attrs(Q);for(F=0;F<v.length;F++)D.cnode(v[F]).up();return D},stop:function(){u&&clearInterval(u)}}}(),P=function(a){k=a;switch(k){case o.HARD:e=[];n=0;case o.SOFT:t.info("Application disabled, the connection is about to stop");H.disable()}},R=function(a,f){if(a)if(a.constructor===Array){var p;for(p=0;p<a.length;p++)try{var u=a[p];u.apply(u,f)}catch(v){t.error(v)}}else t.error(a+" must be wrapped in an array.")},Z=function(){L.start();Y()},$=function(){L.stop()},N=function(){if(k==o.NONE&&
H.enabled&&n===0&&e.length>0){var a=l("log",{xmlns:"urn:ubikod:ermin:0",appid:h.appId});n=e.length;var f;for(f=0;f<n;f++){e[f].log.attrs({toffset:(new Date).getTime()-e[f].timestamp});a.cnode(e[f].log.tree()).up()}H.sendLog(a)}},z=function(a){a={log:a,timestamp:(new Date).getTime()};if(k!=o.HARD){e.push(a);N()}return a},E=function(a){if(a==undefined)throw new y("Name cannot be null.");a=g(a);if(a.length===0)throw new y("Empty string not allowed.");if(a.length>64)throw new y("Name cannot exceed 64 characters.");
return a},S=function(a){if(a)for(var f in a)if(a.hasOwnProperty(f)&&d.test(f)===false)throw new y('The key "'+f+'" of "'+JSON.stringify(a)+'" must follow the format '+d+".");},I=function(a){if(a){S(a);a=JSON.stringify(a);if(a.length>1024)throw new y("Extras are limited to 1024 characters.");if(a[0]!="{")throw new y("Extras must be a non null object (and not an array)");return a}},J=function(a,f){f&&a.c("x").t(f).up()},G=function(a){(x=b.get(A))&&a.attrs({locid:x})},T=function(){t.error("Unable to get the country code for this device")},
Y=function(){x=b.get(A);i.Ajax.get(i.addScheme(h.urls.getIpToCountryUrl()),null,function(a){a=JSON.parse(a.responseText);if(a.countryCode){a=U({countrycode:a.countryCode});var f=M(m.serialize(a));if(!x||x!==f){x=f;b.set(A,f,1);z(V(a))}}},T,T)},U=function(a){var f=l("geoloc",{xmlns:"http://jabber.org/protocol/geoloc"});typeof a.countrycode=="string"&&f.c("countrycode").t(a.countrycode).up();typeof a.latitude=="number"&&f.c("lat").t(""+a.latitude).up();typeof a.locality=="string"&&f.c("locality").t(a.locality).up();
typeof a.longitude=="number"&&f.c("lon").t(""+a.longitude).up();typeof a.region=="string"&&f.c("region").t(a.region).up();return f=f.tree()},V=function(a){return l("location",{id:c(),infoid:q,locid:x}).cnode(a).up()},W=function(){var a=l("endSession",{sid:s});G(a);z(a);K=C=s=null;b.del(r)},X={setEnabled:function(a){if(a!=j)if(j=a){H.enable();t.info("Agent enabled")}else{H.disable();t.info("Agent disabled")}},isEnabled:function(){return j},startActivity:function(a,f){if(j){if(a)a=E(a);f=I(f);var p=
b.get(r);if(!s&&p)s=p;if(!s||!p){s=c();z(l("startSession",{sid:s,infoid:q}))}else if(K){clearTimeout(K);K=null}b.set(r,s,0.05);C=a?a:"default";R(h.onActivityChanged,[C]);p=l("activity",{id:c(),sid:s});G(p);a&&p.attrs({name:a});J(p,f);p=z(p);L.setCurrentActivityLog(p)}},endActivity:function(){if(j)if(K)throw new y("Activity already ended (session is idle)");else if(s){if(h.sessionTimeout>0){C="idle";z(l("idle",{id:c(),sid:s}));K=setTimeout(W,h.sessionTimeout)}else W();L.removeCurrentActivityLog()}else throw new y("Cannot end activity, no activity started.");
},getActivity:function(){return C},startJob:function(a,f){if(j){a=E(a);f=I(f);if(B[a])throw new y('Job "'+a+'" already started');var p=c();B[a]=p;var u=l("startJob",{infoid:q,jobid:p,name:a});J(u,f);u=z(u);L.addJobLog(p,u)}},endJob:function(a){if(j){a=E(a);if(B[a]){var f=B[a];delete B[a];a=l("endJob",{jobid:f});G(a);z(a);L.removeJobLog(f)}else throw new y('Cannot end job "'+a+'" : not started.');}},sendEvent:function(a,f){if(j){a=E(a);f=I(f);var p=l("event",{id:c(),name:a,infoid:q});G(p);J(p,f);z(p)}},
sendSessionEvent:function(a,f){if(j){a=E(a);f=I(f);if(!s)throw new y("Cannot send session event: session not started.");var p=l("event",{id:c(),name:a,infoid:q,sid:s});G(p);J(p,f);z(p)}},sendJobEvent:function(a,f,p){if(j){a=E(a);f=E(f);p=I(p);var u=B[f];if(!u)throw new y('Cannot send job event, no job: "'+f+'"');a=l("event",{id:c(),name:a,infoid:q,jobid:u});G(a);J(a,p);z(a)}},sendError:function(a,f){if(j){a=E(a);f=I(f);var p=l("error",{id:c(),name:a,infoid:q});G(p);J(p,f);z(p)}},sendSessionError:function(a,
f){if(j){a=E(a);f=I(f);if(!s)throw new y("Cannot send session error: session not started.");var p=l("error",{id:c(),name:a,infoid:q,sid:s});G(p);J(p,f);z(p)}},sendJobError:function(a,f,p){if(j){a=E(a);f=E(f);p=I(p);var u=B[f];if(!u)throw new y('Cannot send job error, no job: "'+f+'"');a=l("error",{id:c(),name:a,infoid:q,jobid:u});G(a);J(a,p);z(a)}},sendCrash:function(a,f){if(j){a=g(a);if(a.length===0)throw new y("Empty key is not allowed.");f=g(f);if(f.length===0)throw new y("Empty stack trace is not allowed");
var p=M(a);if(f.length>4096)f=f.substr(0,4096);p=l("crash",{id:c(),crashid:p,infoid:q}).t(f);s&&p.attrs({sid:s});z(p)}},sendLocation:function(a){if(j){a=U(a);var f=M(m.serialize(a));x=f;b.set(A,f,1);z(V(a))}},sendAppInfo:function(a){if(j){S(a);a=JSON.stringify(a);if(a.length>1024)throw new y("AppInfo data is limited to 1024 characters.");z(l("appInfo").t(a))}},_send:function(a){H.enabled&&H.send(a)},sendReachFeedback:function(a,f,p,u){if(j){a=l("reach",{kind:a,contentid:f,status:p});u&&typeof u===
"object"&&a.t(JSON.stringify(u));z(a)}}};s&&X.endActivity();(function(){h.connectionString.split(";").forEach(function(p){p=p.split("=");var u=p[1];switch(p[0]){case "Endpoint":h.endPoint=h.endPoint||u;break;case "AppId":h.appId=u;break;case "SdkKey":h.sdkKey=u}});if(!h.endPoint)throw Error("Engagement end point cannot be parsed from azureEngagement.connectionString or is not set");if(!h.appId)throw Error("Engagement app ID cannot be parsed from azureEngagement.connectionString or is not set");r=
"azureengagement."+h.appId+".sid";A="azureengagement."+h.appId+".locid";w="azureengagement."+h.appId+".activityid";s=b.get(r);if(!h.deviceId){var a=b.get("azureengagement.deviceId");a||(a=M(c()));b.set("azureengagement.deviceId",a);h.deviceId=a}a=h.userAgent;var f=navigator.language||navigator.browserLanguage;if(f&&f.length>2)f=f.substring(0,2);a={serviceVersion:h.serviceVersion,locale:f,firmwareName:a.browser,firmwareVersion:a.version,phoneModel:a.platform,screenSize:screen.width+"x"+screen.height,
timeZoneOffset:-(new Date).getTimezoneOffset()};if(h.appVersionName)a.applicationVersionName=h.appVersionName;if(h.appVersionCode)a.applicationVersionCode=h.appVersionCode;R(h.onInfoUpdated,[a]);a=JSON.stringify(a);q=M(a);f="azureengagement."+h.appId+".infoid";q!=b.get(f)&&z(l("info",{id:c(),infoid:q}).t(a));b.set(f,q,1);H.init(Z,$)})();return X}()})();
