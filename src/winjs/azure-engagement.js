/*
 Copyright (c) Microsoft Corporation. All rights reserved.
*/
/*
 (c) 2009-2013 by Jeff Mott. All rights reserved.
*/
(function(g,u){if(!window.azureEngagement)window.azureEngagement={};var i=azureEngagement.Crypto={},b=i.lib={},f=b.Base=function(){function e(){}return{extend:function(n){e.prototype=this;var q=new e;n&&q.mixIn(n);if(!q.hasOwnProperty("init"))q.init=function(){q.$super.init.apply(this,arguments)};q.init.prototype=q;q.$super=this;return q},create:function(){var n=this.extend();n.init.apply(n,arguments);return n},init:function(){},mixIn:function(n){for(var q in n)if(n.hasOwnProperty(q))this[q]=n[q];
if(n.hasOwnProperty("toString"))this.toString=n.toString},clone:function(){return this.init.prototype.extend(this)}}}(),c=b.WordArray=f.extend({init:function(e,n){e=this.words=e||[];this.sigBytes=n!=u?n:e.length*4},toString:function(e){return(e||m).stringify(this)},concat:function(e){var n=this.words,q=e.words,r=this.sigBytes;e=e.sigBytes;this.clamp();if(r%4)for(var t=0;t<e;t++)n[r+t>>>2]|=(q[t>>>2]>>>24-t%4*8&255)<<24-(r+t)%4*8;else if(q.length>65535)for(t=0;t<e;t+=4)n[r+t>>>2]=q[t>>>2];else n.push.apply(n,
q);this.sigBytes+=e;return this},clamp:function(){var e=this.words,n=this.sigBytes;e[n>>>2]&=4294967295<<32-n%4*8;e.length=g.ceil(n/4)},clone:function(){var e=f.clone.call(this);e.words=this.words.slice(0);return e},random:function(e){for(var n=[],q=0;q<e;q+=4)n.push(g.random()*4294967296|0);return new c.init(n,e)}}),l=i.enc={},m=l.Hex={stringify:function(e){var n=e.words;e=e.sigBytes;for(var q=[],r=0;r<e;r++){var t=n[r>>>2]>>>24-r%4*8&255;q.push((t>>>4).toString(16));q.push((t&15).toString(16))}return q.join("")},
parse:function(e){for(var n=e.length,q=[],r=0;r<n;r+=2)q[r>>>3]|=parseInt(e.substr(r,2),16)<<24-r%8*4;return new c.init(q,n/2)}},d=l.Latin1={stringify:function(e){var n=e.words;e=e.sigBytes;for(var q=[],r=0;r<e;r++)q.push(String.fromCharCode(n[r>>>2]>>>24-r%4*8&255));return q.join("")},parse:function(e){for(var n=e.length,q=[],r=0;r<n;r++)q[r>>>2]|=(e.charCodeAt(r)&255)<<24-r%4*8;return new c.init(q,n)}},o=l.Utf8={stringify:function(e){try{return decodeURIComponent(escape(d.stringify(e)))}catch(n){throw Error("Malformed UTF-8 data");
}},parse:function(e){return d.parse(unescape(encodeURIComponent(e)))}},j=b.BufferedBlockAlgorithm=f.extend({reset:function(){this._data=new c.init;this._nDataBytes=0},_append:function(e){if(typeof e=="string")e=o.parse(e);this._data.concat(e);this._nDataBytes+=e.sigBytes},_process:function(e){var n=this._data,q=n.words,r=n.sigBytes,t=this.blockSize,A=r/(t*4);A=e?g.ceil(A):g.max((A|0)-this._minBufferSize,0);e=A*t;r=g.min(e*4,r);if(e){for(var x=0;x<e;x+=t)this._doProcessBlock(q,x);x=q.splice(0,e);n.sigBytes-=
r}return new c.init(x,r)},clone:function(){var e=f.clone.call(this);e._data=this._data.clone();return e},_minBufferSize:0});b.Hasher=j.extend({cfg:f.extend(),init:function(e){this.cfg=this.cfg.extend(e);this.reset()},reset:function(){j.reset.call(this);this._doReset()},update:function(e){this._append(e);this._process();return this},finalize:function(e){e&&this._append(e);return this._doFinalize()},blockSize:16,_createHelper:function(e){return function(n,q){return(new e.init(q)).finalize(n)}},_createHmacHelper:function(e){return function(n,
q){return(new k.HMAC.init(e,q)).finalize(n)}}});var k=i.algo={};return i})(Math);(function(){var g=azureEngagement.Crypto,u=g.lib.WordArray;g.enc.Base64={stringify:function(i){var b=i.words,f=i.sigBytes,c=this._map;i.clamp();i=[];for(var l=0;l<f;l+=3)for(var m=(b[l>>>2]>>>24-l%4*8&255)<<16|(b[l+1>>>2]>>>24-(l+1)%4*8&255)<<8|b[l+2>>>2]>>>24-(l+2)%4*8&255,d=0;d<4&&l+d*0.75<f;d++)i.push(c.charAt(m>>>6*(3-d)&63));if(b=c.charAt(64))for(;i.length%4;)i.push(b);return i.join("")},parse:function(i){var b=i.length,f=this._map,c=f.charAt(64);if(c){c=i.indexOf(c);if(c!=-1)b=c}c=[];for(var l=
0,m=0;m<b;m++)if(m%4){var d=f.indexOf(i.charAt(m-1))<<m%4*2,o=f.indexOf(i.charAt(m))>>>6-m%4*2;c[l>>>2]|=(d|o)<<24-l%4*8;l++}return u.create(c,l)},_map:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/="}})();(function(g){var u=azureEngagement.Crypto,i=u.lib,b=i.WordArray,f=i.Hasher;i=u.algo;var c=[],l=[];(function(){function d(e){for(var n=g.sqrt(e),q=2;q<=n;q++)if(!(e%q))return false;return true}function o(e){return(e-(e|0))*4294967296|0}for(var j=2,k=0;k<64;){if(d(j)){if(k<8)c[k]=o(g.pow(j,0.5));l[k]=o(g.pow(j,1/3));k++}j++}})();var m=[];i=i.SHA256=f.extend({_doReset:function(){this._hash=new b.init(c.slice(0))},_doProcessBlock:function(d,o){for(var j=this._hash.words,k=j[0],e=j[1],n=j[2],q=j[3],r=
j[4],t=j[5],A=j[6],x=j[7],w=0;w<64;w++){if(w<16)m[w]=d[o+w]|0;else{var C=m[w-15],B=m[w-2];m[w]=((C<<25|C>>>7)^(C<<14|C>>>18)^C>>>3)+m[w-7]+((B<<15|B>>>17)^(B<<13|B>>>19)^B>>>10)+m[w-16]}C=x+((r<<26|r>>>6)^(r<<21|r>>>11)^(r<<7|r>>>25))+(r&t^~r&A)+l[w]+m[w];B=((k<<30|k>>>2)^(k<<19|k>>>13)^(k<<10|k>>>22))+(k&e^k&n^e&n);x=A;A=t;t=r;r=q+C|0;q=n;n=e;e=k;k=C+B|0}j[0]=j[0]+k|0;j[1]=j[1]+e|0;j[2]=j[2]+n|0;j[3]=j[3]+q|0;j[4]=j[4]+r|0;j[5]=j[5]+t|0;j[6]=j[6]+A|0;j[7]=j[7]+x|0},_doFinalize:function(){var d=this._data,
o=d.words,j=this._nDataBytes*8,k=d.sigBytes*8;o[k>>>5]|=128<<24-k%32;o[(k+64>>>9<<4)+14]=g.floor(j/4294967296);o[(k+64>>>9<<4)+15]=j;d.sigBytes=o.length*4;this._process();return this._hash},clone:function(){var d=f.clone.call(this);d._hash=this._hash.clone();return d}});u.SHA256=f._createHelper(i);u.HmacSHA256=f._createHmacHelper(i)})(Math);/*
 Copyright 2006-2008, OGG, LLC
*/
(function(g){function u(b,f){return new i.Builder(b,f)}var i;i={VERSION:"@VERSION@",addNamespace:function(b,f){i.NS[b]=f},ElementType:{NORMAL:1,TEXT:3,CDATA:4},forEachChild:function(b,f,c){var l,m;for(l=0;l<b.childNodes.length;l++){m=b.childNodes[l];if(m.nodeType==i.ElementType.NORMAL&&(!f||this.isTagEqual(m,f)))c(m)}},isTagEqual:function(b,f){return b.tagName.toLowerCase()==f.toLowerCase()},_xmlGenerator:null,_makeGenerator:function(){var b;if(document.implementation.createDocument)b=document.implementation.createDocument("jabber:client",
"strophe",null);else if(window.ActiveXObject){b=this._getIEXmlDom();b.appendChild(b.createElement("strophe"))}return b},xmlGenerator:function(){if(!i._xmlGenerator)i._xmlGenerator=i._makeGenerator();return i._xmlGenerator},_getIEXmlDom:function(){for(var b=null,f=["Msxml2.DOMDocument.6.0","Msxml2.DOMDocument.5.0","Msxml2.DOMDocument.4.0","MSXML2.DOMDocument.3.0","MSXML2.DOMDocument","MSXML.DOMDocument","Microsoft.XMLDOM"],c=0;c<f.length;c++)if(b===null)try{b=new ActiveXObject(f[c])}catch(l){b=null}else break;
return b},xmlElement:function(b){if(!b)return null;var f=i.xmlGenerator().createElement(b),c,l,m;for(c=1;c<arguments.length;c++)if(arguments[c])if(typeof arguments[c]=="string"||typeof arguments[c]=="number")f.appendChild(i.xmlTextNode(arguments[c]));else if(typeof arguments[c]=="object"&&typeof arguments[c].sort=="function")for(l=0;l<arguments[c].length;l++)typeof arguments[c][l]=="object"&&typeof arguments[c][l].sort=="function"&&f.setAttribute(arguments[c][l][0],arguments[c][l][1]);else if(typeof arguments[c]==
"object")for(m in arguments[c])arguments[c].hasOwnProperty(m)&&f.setAttribute(m,arguments[c][m]);return f},xmlescape:function(b){b=b.replace(/\&/g,"&amp;");b=b.replace(/</g,"&lt;");return b=b.replace(/>/g,"&gt;")},xmlTextNode:function(b){b=i.xmlescape(b);return i.xmlGenerator().createTextNode(b)},getText:function(b){if(!b)return null;var f="";if(b.childNodes.length===0&&(b.nodeType==i.ElementType.TEXT||b.nodeType==i.ElementType.CDATA))f+=b.nodeValue;for(var c=0;c<b.childNodes.length;c++){var l=b.childNodes[c];
if(l.nodeType==i.ElementType.TEXT||l.nodeType==i.ElementType.CDATA)f+=b.childNodes[c].nodeValue}return f},copyElement:function(b){var f,c;if(b.nodeType==i.ElementType.NORMAL){c=i.xmlElement(b.tagName);for(f=0;f<b.attributes.length;f++)c.setAttribute(b.attributes[f].nodeName.toLowerCase(),b.attributes[f].value);for(f=0;f<b.childNodes.length;f++)c.appendChild(i.copyElement(b.childNodes[f]))}else if(b.nodeType==i.ElementType.TEXT||b.nodeType==i.ElementType.CDATA)c=i.xmlTextNode(b.nodeValue);return c},
serialize:function(b){var f;if(!b)return null;if(typeof b.tree==="function")b=b.tree();var c=b.nodeName,l,m;if(b.getAttribute("_realname"))c=b.getAttribute("_realname");f="<"+c;for(l=0;l<b.attributes.length;l++)if(b.attributes[l].nodeName!="_realname")f+=" "+b.attributes[l].nodeName+"='"+b.attributes[l].value.replace(/&/g,"&amp;").replace(/\'/g,"&apos;").replace(/</g,"&lt;")+"'";if(b.childNodes.length>0){f+=">";for(l=0;l<b.childNodes.length;l++){m=b.childNodes[l];if(m.nodeType==i.ElementType.NORMAL)f+=
i.serialize(m);else if(m.nodeType==i.ElementType.TEXT)f+=m.nodeValue;else if(m.nodeType==i.ElementType.CDATA)f+="<![CDATA["+m.nodeValue+"]]\>"}f+="</"+c+">"}else f+="/>";return f}};i.Builder=function(b,f){this.node=this.nodeTree=i.xmlElement(b,f)};i.Builder.prototype={tree:function(){return this.nodeTree},toString:function(){return i.serialize(this.nodeTree)},up:function(){this.node=this.node.parentNode;return this},attrs:function(b){for(var f in b)b.hasOwnProperty(f)&&this.node.setAttribute(f,b[f]);
return this},c:function(b,f){var c=i.xmlElement(b,f);this.node.appendChild(c);this.node=c;return this},cnode:function(b){var f=i.xmlGenerator(),c;try{c=f.importNode(b,true)}catch(l){c=i.copyElement(b)}this.node.appendChild(c);this.node=c;return this},t:function(b){this.node.appendChild(i.xmlTextNode(b));return this}};g&&g(i,u)})(function(g,u){azureEngagement.Strophe=g;azureEngagement.$build=u});/*
 Copyright (c) Microsoft Corporation. All rights reserved.
*/
(function(){var g=azureEngagement;if(!g.connectionString)throw Error("azureEngagement.connectionString must be set");g.alias=g.alias||"engagement";window[g.alias]=g;if(typeof g.sessionTimeout!="number")g.sessionTimeout=1E4;g.serviceVersion="2.0.1";g.tag=g.tag||"ENGAGEMENT";g.urls=g.urls||{};g.urls.scheme=g.urls.scheme||"https://";g.urls.getIpToCountryUrl=g.urls.getIpToCountryUrl||function(){return g.endPoint+"/ip-to-country"};g.urls.getLoggerUrl=g.urls.getLoggerUrl||function(){return g.endPoint+"/log"};
g.utils=function(){var u=g.Crypto,i=u.enc,b="0123456789abcdef".split(""),f=function(d){return d<10?"0"+d:d},c=function(){return window.XMLHttpRequest?function(d,o,j){var k=new XMLHttpRequest;k.onreadystatechange=function(){if(k.readyState==4){m.logAjaxResult(d,k);k.status==200?o(k):j(k);m.destroyAjax(k)}};return k}:function(){}}(),l=function(d,o,j,k,e,n,q){if(e=c(o,e,n)){g.debug&&g.console.log("SEND: "+d,o);try{e.open(d,o,true);j&&e.setRequestHeader("Authorization",j);e.withCredentials=false;e.send(k)}catch(r){q(r)}}},
m={printCurrentTime:function(){var d=new Date;return f(d.getHours())+":"+f(d.getMinutes())+":"+f(d.getSeconds())},hasClass:function(d,o){return(" "+m.trim(d.className)+" ").indexOf(" "+o+" ")>-1},addClass:function(d,o){if(m.hasClass(d,o)===false)d.className=m.trim(d.className+" "+o)},removeClass:function(d,o){d.className=d.className.replace(RegExp("(^|\\s)"+o+"(?:\\s|$)"),"")},trim:String.trim||function(d){return d.replace(/^\s\s*/,"").replace(/\s\s*$/,"")},uuid:function(){var d=[],o,j;d[12]="4";
for(j=0;j<32;j++)if(!d[j]){o=0|Math.random()*16;d[j]=b[j==16?o&3|8:o]}return d.join("")},getTag:function(d,o){var j=d.getElementsByTagName(o);if(j.length)return j[0]},getText:function(d){if(d=g.Strophe.getText(d))return m.trim(d)},getTagText:function(d,o){return m.getText(m.getTag(d,o))},getDateFromHours:function(d){var o=new Date;o.setTime(o.getTime()+d*36E5);return o},getCookie:function(d){d+="=";var o=document.cookie.split(";"),j;for(j=0;j<o.length;j++){for(var k=o[j];k.charAt(0)==" ";)k=k.substring(1,
k.length);if(k.indexOf(d)===0)return k.substring(d.length,k.length)}return null},setCookie:function(d,o,j){j=j?"; expires="+m.getDateFromHours(j).toGMTString():"";document.cookie=d+"="+o+j+"; path=/"},deleteCookie:function(d){m.setCookie(d,"",-1)},addScheme:function(d){/^((https?:)?\/\/|\/)/.test(d)||(d=g.urls.scheme+d);return d},Base64:{encode:function(d){return i.Base64.stringify(i.Utf8.parse(d))},decode:function(d){return i.Base64.parse(d).toString(i.Utf8)}},SHA256:{hash128:function(d){d=u.SHA256(d).toString(i.Hex);
return d.substring(0,d.length/2)}},Ajax:{post:function(d,o,j,k,e,n){l("POST",d,o,j,k,e,n)},get:function(d,o,j,k,e){l("GET",d,o,null,j,k,e)}},destroyAjax:function(d){try{d.destroy()}catch(o){}},logAjaxResult:function(d,o){g.debug&&g.console.log("RECV:",d,o.responseText)},getQueryParameter:function(d){var o=window.location.search.substring(1).split("&"),j;for(j=0;j<o.length;j++){var k=o[j].split("=");if(k[0]==d)return k[1]}},addListener:function(d,o,j){if(d)if(d.addEventListener)d.addEventListener(o,
j,false);else d.attachEvent&&d.attachEvent(o,j)},removeListener:function(d,o,j){if(d)if(d.removeEventListener)d.removeEventListener(o,j);else d.detachEvent&&d.detachEvent(o,j)},retryer:function(d,o,j){var k=0;return{reset:function(){k=0},retry:function(e){var n=true;if(k==0)k=o;else if(k!=d)k=Math.min(k*j,d);else n=false;if(n){n=k/2;k=n+parseInt(Math.random()*n)}console.log("Waiting "+k+"ms before retrying...");this.retryTimeout=setTimeout(function(){e()},k)}}}};return m}();g.storage=g.storage||function(){var u=
g.utils,i;return i=window.localStorage?{set:function(b,f,c){if(c=="session"){sessionStorage[b]=JSON.stringify(f);localStorage.removeItem(b)}else{localStorage[b]=JSON.stringify({ttl:c?u.getDateFromHours(c).getTime():undefined,val:f});sessionStorage.removeItem(b)}},get:function(b){try{var f=sessionStorage[b];if(f)return JSON.parse(f);else{f=localStorage[b];f=JSON.parse(f);if((new Date).getTime()>f.ttl){i.del(b);return null}else return f.val}}catch(c){return null}},del:function(b){sessionStorage.removeItem(b);
localStorage.removeItem(b)}}:{get:u.getCookie,set:function(b,f,c){if(c){if(c=="session")c=null}else c=876E4;u.setCookie(b,f,c)},del:u.deleteCookie}}();g.console=g.console||function(){if(window.console){var u=navigator.userAgent.search("Android")>-1,i=u||navigator.userAgent.search("iPhone")>-1,b=Array.prototype.slice,f=function(c,l){l=["["+g.tag+"]"].concat(l);u||(l=[g.utils.printCurrentTime()].concat(l));var m=function(o,j){try{return o[j]}catch(k){return false}};if(!m(c,"apply")||i){var d=l.join(" ");
m(c,"call")?c.call(console,d):c(d)}else c.apply(console,l)};return{log:function(){g.debug&&f(console.log,b.apply(arguments))},error:function(){g.debug&&f(console.error,b.apply(arguments))},warn:function(){g.debug&&f(console.warn,b.apply(arguments))},info:function(){g.debug&&f(console.info,b.apply(arguments))}}}else return{log:function(){},error:function(){},warn:function(){},info:function(){}}}();g.userAgent=function(){var u=[{string:navigator.platform,subString:"Win",identity:"Windows"},{string:navigator.platform,
subString:"Mac",identity:"Mac"},{string:navigator.platform,subString:"iPad",identity:"iPad"},{string:navigator.platform,subString:"iPod",identity:"iPod"},{string:navigator.platform,subString:"iPhone",identity:"iPhone"},{string:navigator.userAgent,subString:"Android",identity:"Android"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"hpwOS",identity:"webOS"},{string:navigator.platform,subString:"SHADOW",identity:"Samsung TV"},{string:navigator.platform,
subString:"Linux",identity:"Linux"}],i,b=function(c){var l;for(l=0;l<c.length;l++){var m=c[l].string,d=c[l].prop;i=c[l].versionSearch||c[l].identity;if(m){if(m.indexOf(c[l].subString)!=-1)return c[l].identity}else if(d)return c[l].identity}},f=function(c){var l=c.indexOf(i);if(l!=-1)return parseFloat(c.substring(l+i.length+1))};return{browser:b([{string:navigator.userAgent,subString:"Edge",identity:"Edge"},{string:navigator.userAgent,subString:"OPR",versionSearch:"OPR",identity:"Opera"},{string:navigator.userAgent,
subString:"Chrome",identity:"Chrome"},{string:navigator.userAgent,subString:"OmniWeb",versionSearch:"OmniWeb/",identity:"OmniWeb"},{string:navigator.userAgent,subString:"webOS",identity:"webOS"},{string:navigator.userAgent,subString:"hpwOS",identity:"webOS",versionSearch:"hpwOS"},{string:navigator.vendor,subString:"Apple",identity:"Safari",versionSearch:"Version"},{prop:window.opera,identity:"Opera",versionSearch:"Version"},{string:navigator.vendor,subString:"iCab",identity:"iCab"},{string:navigator.vendor,
subString:"KDE",identity:"Konqueror"},{string:navigator.appName,subString:"Maple",identity:"Maple"},{string:navigator.userAgent,subString:"Firefox",identity:"Firefox"},{string:navigator.vendor,subString:"Camino",identity:"Camino"},{string:navigator.userAgent,subString:"Netscape",identity:"Netscape"},{string:navigator.userAgent,subString:"MSIE",identity:"Internet Explorer",versionSearch:"MSIE"},{string:navigator.userAgent,subString:"Android",identity:"WebKit",versionSearch:"Version"},{string:navigator.userAgent,
subString:"Trident",identity:"Internet Explorer",versionSearch:"rv"},{string:navigator.userAgent,subString:"Gecko",identity:"Mozilla",versionSearch:"rv"},{string:navigator.userAgent,subString:"Mozilla",identity:"Netscape",versionSearch:"Mozilla"}]),version:f(navigator.userAgent)||f(navigator.appVersion),platform:b(u)}}();g.agent=function(){var u=g.console,i=g.utils,b=g.storage,f=i.trim,c=i.uuid,l=g.Strophe,m=g.$build,d=/^[a-zA-Z][a-zA-Z_0-9]*$/,o={NONE:0,SOFT:1,HARD:2},j=o.NONE,k=true,e=[],n=0,q,
r,t,A,x,w,C=null,B={},K,M=i.SHA256.hash128,F={enabled:false,init:function(a,h){this.authHeader="Basic "+i.Base64.encode(g.deviceId+"."+g.appId+":"+g.sdkKey);this.retryer=i.retryer(36E5,6E4,2);var p=this;this.onEnabled=function(){u.info("Connection enabled");p.enabled=true;a()};this.onDisabled=function(){u.warn("Connection disabled");p.enabled=false;h();p.retryer.reset();n=0};j==o.NONE&&this.enable()},enable:function(){if(!window.navigator||typeof window.navigator.onLine==="undefined"){u.warn("Can't monitor connection status, state forced to enabled.");
this.onEnabled()}else{if(window.navigator.onLine)this.onEnabled();else this.onDisabled();i.addListener(window,"online",this.onEnabled);i.addListener(window,"offline",this.onDisabled)}},disable:function(){i.removeListener(window,"online",this.onEnabled);i.removeListener(window,"offline",this.onDisabled);this.onDisabled()},sendLog:function(a){var h=this.retryer,p=i.addScheme(g.urls.getLoggerUrl());i.Ajax.post(p,this.authHeader,a.toString(),function(){h.reset();e=e.slice(n);n=0;N()},function(s){u.error("Error sending logs");
s=s.status;if(s==410)O(o.HARD);else if(s>=300&&s<500&&s!=408){O(o.SOFT);n=0}else F.enabled&&h.retry(function(){n=0;N()})},function(){u.error("Fatal error sending logs");O(o.SOFT)})}},y=function(a){this.message=a;this.name="["+g.tag+"] Error"};y.prototype=Error();var L=function(){var a=null,h=null,p={},s=null;return{start:function(){this.stop();s=setInterval(function(){if(a){var v;v=b.get(w);if(!v||v===h){b.set(w,h,0.025);v=true}else v=false;v?e.push(a):b.set(r,t,0.05)}for(var D in p)p.hasOwnProperty(D)&&
e.push(p[D]);N()},6E4)},setCurrentActivityLog:function(v){if(v.log&&v.timestamp){a={log:this.cloneWithRepost(v.log),timestamp:v.timestamp};h=v.log.tree().getAttribute("id");b.set(w,h,0.025)}},removeCurrentActivityLog:function(){b.get(w)===h&&b.del(w);h=a=null},addJobLog:function(v,D){if(v&&D.log&&D.timestamp)p[v]={log:this.cloneWithRepost(D.log),timestamp:D.timestamp}},removeJobLog:function(v){delete p[v]},cloneWithRepost:function(v){var D=g.$build(v.nodeTree.nodeName),P=v.nodeTree.attributes;v=v.nodeTree.childNodes;
var G,R={repost:"true"};for(G=0;G<P.length;G++)R[P[G].name]=P[G].value;D.attrs(R);for(G=0;G<v.length;G++)D.cnode(v[G]).up();return D},stop:function(){s&&clearInterval(s)}}}(),O=function(a){j=a;switch(j){case o.HARD:e=[];n=0;case o.SOFT:u.info("Application disabled, the connection is about to stop");F.disable()}},S=function(a,h){if(a)if(a.constructor===Array){var p;for(p=0;p<a.length;p++)try{var s=a[p];s.apply(s,h)}catch(v){u.error(v)}}else u.error(a+" must be wrapped in an array.")},Z=function(){L.start();
Y()},$=function(){L.stop()},N=function(){if(j==o.NONE&&F.enabled&&n===0&&e.length>0){var a=m("log",{xmlns:"urn:ubikod:ermin:0",appid:g.appId});n=e.length;var h;for(h=0;h<n;h++){e[h].log.attrs({toffset:(new Date).getTime()-e[h].timestamp});a.cnode(e[h].log.tree()).up()}F.sendLog(a)}},z=function(a){a={log:a,timestamp:(new Date).getTime()};if(j!=o.HARD){e.push(a);N()}return a},E=function(a){if(a==undefined)throw new y("Name cannot be null.");a=f(a);if(a.length===0)throw new y("Empty string not allowed.");
if(a.length>64)throw new y("Name cannot exceed 64 characters.");return a},T=function(a){if(a)for(var h in a)if(a.hasOwnProperty(h)&&d.test(h)===false)throw new y('The key "'+h+'" of "'+JSON.stringify(a)+'" must follow the format '+d+".");},I=function(a){if(a){T(a);a=JSON.stringify(a);if(a.length>1024)throw new y("Extras are limited to 1024 characters.");if(a[0]!="{")throw new y("Extras must be a non null object (and not an array)");return a}},J=function(a,h){h&&a.c("x").t(h).up()},H=function(a){(x=
b.get(A))&&a.attrs({locid:x})},U=function(){u.error("Unable to get the country code for this device")},Y=function(){x=b.get(A);i.Ajax.get(i.addScheme(g.urls.getIpToCountryUrl()),null,function(a){a=JSON.parse(a.responseText);if(a.countryCode){a=V({countrycode:a.countryCode});var h=M(l.serialize(a));if(!x||x!==h){x=h;b.set(A,h,1);z(W(a))}}},U,U)},V=function(a){var h=m("geoloc",{xmlns:"http://jabber.org/protocol/geoloc"});typeof a.countrycode=="string"&&h.c("countrycode").t(a.countrycode).up();typeof a.latitude==
"number"&&h.c("lat").t(""+a.latitude).up();typeof a.locality=="string"&&h.c("locality").t(a.locality).up();typeof a.longitude=="number"&&h.c("lon").t(""+a.longitude).up();typeof a.region=="string"&&h.c("region").t(a.region).up();return h=h.tree()},W=function(a){return m("location",{id:c(),infoid:q,locid:x}).cnode(a).up()},X=function(){var a=m("endSession",{sid:t});H(a);z(a);K=C=t=null;b.del(r)},Q={setEnabled:function(a){if(a!=k)if(k=a){F.enable();u.info("Agent enabled")}else{F.disable();u.info("Agent disabled")}},
isEnabled:function(){return k},startActivity:function(a,h){if(k){if(a)a=E(a);h=I(h);var p=b.get(r);if(!t&&p)t=p;if(!t||!p){t=c();z(m("startSession",{sid:t,infoid:q}))}else if(K){clearTimeout(K);K=null}b.set(r,t,0.05);C=a?a:"default";S(g.onActivityChanged,[C]);p=m("activity",{id:c(),sid:t});H(p);a&&p.attrs({name:a});J(p,h);p=z(p);L.setCurrentActivityLog(p)}},endActivity:function(){if(k)if(K)throw new y("Activity already ended (session is idle)");else if(t){if(g.sessionTimeout>0){C="idle";z(m("idle",
{id:c(),sid:t}));K=setTimeout(X,g.sessionTimeout)}else X();L.removeCurrentActivityLog()}else throw new y("Cannot end activity, no activity started.");},getActivity:function(){return C},startJob:function(a,h){if(k){a=E(a);h=I(h);if(B[a])throw new y('Job "'+a+'" already started');var p=c();B[a]=p;var s=m("startJob",{infoid:q,jobid:p,name:a});J(s,h);s=z(s);L.addJobLog(p,s)}},endJob:function(a){if(k){a=E(a);if(B[a]){var h=B[a];delete B[a];a=m("endJob",{jobid:h});H(a);z(a);L.removeJobLog(h)}else throw new y('Cannot end job "'+
a+'" : not started.');}},sendEvent:function(a,h){if(k){a=E(a);h=I(h);var p=m("event",{id:c(),name:a,infoid:q});H(p);J(p,h);z(p)}},sendSessionEvent:function(a,h){if(k){a=E(a);h=I(h);if(!t)throw new y("Cannot send session event: session not started.");var p=m("event",{id:c(),name:a,infoid:q,sid:t});H(p);J(p,h);z(p)}},sendJobEvent:function(a,h,p){if(k){a=E(a);h=E(h);p=I(p);var s=B[h];if(!s)throw new y('Cannot send job event, no job: "'+h+'"');a=m("event",{id:c(),name:a,infoid:q,jobid:s});H(a);J(a,p);
z(a)}},sendError:function(a,h){if(k){a=E(a);h=I(h);var p=m("error",{id:c(),name:a,infoid:q});H(p);J(p,h);z(p)}},sendSessionError:function(a,h){if(k){a=E(a);h=I(h);if(!t)throw new y("Cannot send session error: session not started.");var p=m("error",{id:c(),name:a,infoid:q,sid:t});H(p);J(p,h);z(p)}},sendJobError:function(a,h,p){if(k){a=E(a);h=E(h);p=I(p);var s=B[h];if(!s)throw new y('Cannot send job error, no job: "'+h+'"');a=m("error",{id:c(),name:a,infoid:q,jobid:s});H(a);J(a,p);z(a)}},sendCrash:function(a,
h){if(k){a=f(a);if(a.length===0)throw new y("Empty key is not allowed.");h=f(h);if(h.length===0)throw new y("Empty stack trace is not allowed");var p=M(a);if(h.length>4096)h=h.substr(0,4096);p=m("crash",{id:c(),crashid:p,infoid:q}).t(h);t&&p.attrs({sid:t});z(p)}},sendLocation:function(a){if(k){a=V(a);var h=M(l.serialize(a));x=h;b.set(A,h,1);z(W(a))}},sendAppInfo:function(a){if(k){T(a);a=JSON.stringify(a);if(a.length>1024)throw new y("AppInfo data is limited to 1024 characters.");z(m("appInfo").t(a))}},
_send:function(a){F.enabled&&F.send(a)},sendReachFeedback:function(a,h,p,s){if(k){a=m("reach",{kind:a,contentid:h,status:p});s&&typeof s==="object"&&a.t(JSON.stringify(s));z(a)}}};if(window.XDomainRequest&&!("withCredentials"in new XMLHttpRequest)){j=o.HARD;k=false;Q.setEnabled=function(){};u.info("This browser is not supported, SDK disabled.")}t&&Q.endActivity();(function(){for(var a=g.connectionString.split(";"),h=0;h<a.length;h++){var p=a[h].split("="),s=p[0];p=p[1];switch(s){case "Endpoint":g.endPoint=
g.endPoint||p;break;case "AppId":g.appId=p;break;case "SdkKey":g.sdkKey=p}}if(!g.endPoint)throw Error("Engagement end point cannot be parsed from azureEngagement.connectionString or is not set");if(!g.appId)throw Error("Engagement app ID cannot be parsed from azureEngagement.connectionString or is not set");r="azureengagement."+g.appId+".sid";A="azureengagement."+g.appId+".locid";w="azureengagement."+g.appId+".activityid";t=b.get(r);if(!g.deviceId){s="azureengagement.deviceId";(a=b.get(s))||(a=M(c()));
b.set(s,a);g.deviceId=a}s=g.userAgent;if((a=navigator.language||navigator.browserLanguage)&&a.length>2)a=a.substring(0,2);s={serviceVersion:g.serviceVersion,locale:a,firmwareName:s.browser,firmwareVersion:s.version,phoneModel:s.platform,screenSize:screen.width+"x"+screen.height,timeZoneOffset:-(new Date).getTimezoneOffset()};if(g.appVersionName)s.applicationVersionName=g.appVersionName;if(g.appVersionCode)s.applicationVersionCode=g.appVersionCode;S(g.onInfoUpdated,[s]);s=JSON.stringify(s);q=M(s);
a="azureengagement."+g.appId+".infoid";q!=b.get(a)&&z(m("info",{id:c(),infoid:q}).t(s));b.set(a,q,1);F.init(Z,$)})();return Q}()})();
